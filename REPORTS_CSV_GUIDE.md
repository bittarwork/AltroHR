# دليل تحميل التقارير بصيغة CSV

## نظرة عامة

تم إضافة ميزة تحميل التقارير بصيغة CSV إلى نظام إدارة الموارد البشرية AltroHR، مما يتيح للمستخدمين تحميل التقارير المختلفة بصيغة قابلة للقراءة والتحليل في برامج جداول البيانات مثل Excel.

## المميزات الجديدة

### 1. تحميل التقارير المباشر

- **تحميل فوري**: إمكانية تحميل التقارير مباشرة بدون إنشاء مسبق
- **تحميل مخصص**: تحميل التقارير مع إعدادات التاريخ والفلترة المناسبة
- **أنواع التقارير المدعومة**:
  - تقرير الموظفين
  - تقرير الحضور والانصراف
  - تقرير الإجازات
  - تقرير الأقسام

### 2. تحميل التقارير المحفوظة

- تحميل التقارير التي تم إنشاؤها مسبقاً
- الحفاظ على البيانات الأصلية للتقرير
- إمكانية الوصول السريع للتقارير السابقة

### 3. دعم اللغة العربية

- **BOM Support**: إضافة Byte Order Mark لدعم النصوص العربية
- **ترجمة الحقول**: جميع أسماء الأعمدة والقيم مترجمة للعربية
- **تنسيق التواريخ**: عرض التواريخ بالتقويم الهجري/الميلادي

## الواجهة الأمامية

### تحديثات HRReportsTab

#### 1. أزرار التحميل في الكاردات

```jsx
// كل كارد تقرير يحتوي على زرين:
<button>إنشاء</button>        // لإنشاء تقرير جديد
<button>تحميل CSV</button>    // لتحميل التقرير مباشرة
```

#### 2. تحميل التقارير الموجودة

```jsx
// في قائمة التقارير الأخيرة:
<button title="تحميل التقرير CSV">
  <FiDownload />
</button>
```

#### 3. تحميل من المودال

```jsx
// بعد إنشاء تقرير جديد:
<button>تحميل CSV</button> // في مودال التأكيد
```

## الواجهة الخلفية

### Routes الجديدة

```javascript
// تحميل التقارير المباشرة
GET /api/reports/download/employees/csv
GET /api/reports/download/attendance/csv
GET /api/reports/download/leaves/csv
GET /api/reports/download/departments/csv

// تحميل تقرير محدد
GET /api/reports/:id/download/csv
```

### Controllers الجديدة

#### 1. downloadEmployeesReportCSV

```javascript
// يحتوي على:
- جلب بيانات الموظفين
- تنسيق البيانات للـ CSV
- ترجمة الحقول للعربية
- إعداد headers للتحميل
```

#### 2. downloadAttendanceReportCSV

```javascript
// يحتوي على:
- فلترة بيانات الحضور حسب التاريخ
- تنسيق الأوقات والتواريخ
- حساب ساعات العمل
- دعم فلترة الأقسام
```

#### 3. downloadLeavesReportCSV

```javascript
// يحتوي على:
- فلترة طلبات الإجازات
- ترجمة أنواع الإجازات
- حساب عدد الأيام
- عرض حالة الطلبات
```

#### 4. downloadDepartmentsReportCSV

```javascript
// يحتوي على:
- إحصائيات الأقسام
- عدد الموظفين في كل قسم
- حالة الأقسام (نشط/غير نشط)
- تواريخ الإنشاء والتحديث
```

#### 5. downloadReportCSV

```javascript
// تحميل تقرير محدد بناءً على:
- نوع التقرير (category)
- البيانات المحفوظة
- تنسيق مخصص لكل نوع
```

## هيكل ملفات CSV

### 1. تقرير الموظفين

```csv
الاسم,البريد الإلكتروني,الهاتف,الوظيفة,القسم,تاريخ التوظيف,الحالة,العنوان
أحمد محمد,ahmed@company.com,0501234567,موظف,تقنية المعلومات,2023-01-15,نشط,الرياض
```

### 2. تقرير الحضور

```csv
اسم الموظف,البريد الإلكتروني,القسم,التاريخ,وقت الحضور,وقت الانصراف,إجمالي الساعات,الحالة,ملاحظات
أحمد محمد,ahmed@company.com,تقنية المعلومات,2024-01-15,08:00:00,17:00:00,8,حاضر,لا توجد ملاحظات
```

### 3. تقرير الإجازات

```csv
اسم الموظف,البريد الإلكتروني,القسم,نوع الإجازة,تاريخ البداية,تاريخ النهاية,عدد الأيام,الحالة,سبب الإجازة,تاريخ الطلب,ملاحظات
أحمد محمد,ahmed@company.com,تقنية المعلومات,سنوية,2024-02-01,2024-02-05,5,موافق عليها,راحة,2024-01-20,لا توجد ملاحظات
```

### 4. تقرير الأقسام

```csv
اسم القسم,الوصف,حالة القسم,إجمالي الموظفين,الموظفون النشطون,الموظفون غير النشطون,تاريخ الإنشاء,آخر تحديث
تقنية المعلومات,قسم تطوير البرمجيات,نشط,15,14,1,2023-01-01,2024-01-15
```

## التقنيات المستخدمة

### 1. مكتبة json2csv

```bash
npm install json2csv
```

### 2. معالجة البيانات

```javascript
const { Parser } = require("json2csv");

// تحديد الحقول
const fields = ["الاسم", "البريد الإلكتروني", "الهاتف"];

// تحويل البيانات
const json2csvParser = new Parser({ fields });
const csv = json2csvParser.parse(csvData);
```

### 3. إعداد التحميل

```javascript
// Headers للتحميل
res.setHeader("Content-Type", "text/csv; charset=utf-8");
res.setHeader("Content-Disposition", `attachment; filename="${fileName}"`);
res.setHeader("Content-Length", Buffer.byteLength(csv, "utf8"));

// إضافة BOM للدعم العربي
res.write("\ufeff");
res.end(csv);
```

## أمان النظام

### 1. التحقق من الصلاحيات

```javascript
// جميع routes محمية بـ:
auth, role(["admin", "hr"]);
```

### 2. التحقق من التوكن

```javascript
const token = user?.token;
if (!token) return;
```

### 3. معالجة الأخطاء

```javascript
try {
  // عملية التحميل
} catch (error) {
  console.error("خطأ في تحميل التقرير:", error);
  res.status(500).json({
    message: "فشل في تحميل التقرير",
    error: error.message,
  });
}
```

## حالات الاستخدام

### 1. المدير الإداري

- تحميل تقارير شاملة لجميع الموظفين
- تحليل بيانات الحضور والإنتاجية
- مراجعة طلبات الإجازات

### 2. موظف الموارد البشرية

- إعداد تقارير دورية للإدارة
- تحليل إحصائيات الموظفين
- متابعة أداء الأقسام

### 3. التحليل الخارجي

- استيراد البيانات لبرامج التحليل
- إنشاء لوحات معلومات
- إعداد تقارير مخصصة

## المميزات التقنية

### 1. الأداء

- تحميل مباشر بدون حفظ ملفات مؤقتة
- معالجة البيانات في الذاكرة
- ضغط البيانات للتحميل السريع

### 2. قابلية التوسع

- إمكانية إضافة أنواع تقارير جديدة
- دعم فلترة متقدمة
- تخصيص الحقول حسب الحاجة

### 3. سهولة الاستخدام

- واجهة بسيطة ومفهومة
- أزرار واضحة ومميزة
- رسائل تأكيد وتنبيه

## الاختبار والتطوير

### 1. اختبار التحميل

```bash
# تشغيل الخادم
npm start

# الوصول لصفحة التقارير
http://localhost:3000/hr-dashboard
```

### 2. اختبار APIs

```bash
# اختبار تحميل تقرير الموظفين
curl -H "Authorization: Bearer YOUR_TOKEN" \
     -o employees.csv \
     "http://localhost:5000/api/reports/download/employees/csv"
```

### 3. فحص الملفات

- التأكد من encoding UTF-8
- فحص البيانات العربية
- التحقق من تنسيق التواريخ

## الخلاصة

تم تطوير نظام تحميل التقارير بصيغة CSV بشكل شامل ومتكامل، مع دعم كامل للغة العربية وجميع أنواع التقارير المطلوبة. النظام جاهز للاستخدام الفوري ويوفر تجربة مستخدم ممتازة مع أداء عالي وأمان محكم.

## المطلوب للتطوير المستقبلي

1. **إضافة فلترة متقدمة**: إمكانية فلترة التقارير بمعايير أكثر تفصيلاً
2. **جدولة التقارير**: إمكانية جدولة تحميل التقارير بشكل دوري
3. **تنسيقات أخرى**: دعم تنسيقات PDF و Excel
4. **تحليل البيانات**: إضافة مؤشرات وإحصائيات متقدمة
5. **تخصيص التقارير**: إمكانية تخصيص الحقول والتنسيق

---

_تم تطوير هذه الميزة بواسطة فريق التطوير - يناير 2024_
